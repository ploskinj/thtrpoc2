(()=>{var _=(n,t)=>()=>(n&&(t=n(n=0)),t);var C=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports);var m,x=_(()=>{m=class{constructor(){this.sex="male",this.skin=1,this.direction=0,this.animation="idle_normal_loop1",this.handle=""}}});var f,g,v=_(()=>{f=class{constructor(){this.animations=null,this.loaded=!1}async load(){this.loaded||(await this.load_avatar_json(),await this.load_avatar_images(),this.loaded=!0)}async load_avatar_images(){let t=[];this.animations.forEach((e,i)=>{e.forEach((s,p)=>{s.forEach((l,o)=>{l.forEach((a,d)=>{let c=new Image,h=a.sprite_sheet_dir+a.sprite_sheet_file_name,r=new Promise((F,j)=>{c.onload=()=>F(),c.onerror=()=>j(new Error(`Failed to load: ${h}`)),c.src=h});a.img=c,t.push(r)})})})}),await Promise.all(t)}async load_avatar_json(){let e=await(await fetch("/avatars/avatar.json")).json();this.animations=new Map;let i=["male","female"],s=[1,2,3,4],p=["north","south","east","west"],l={north:"n",south:"s",east:"e",west:"w"};i.forEach(o=>{this.animations.set(o,new Map),s.forEach(a=>{this.animations.get(o).set(a,new Map),p.forEach(d=>{this.animations.get(o).get(a).set(d,new Map),e.animations.forEach(c=>{let h=Object.keys(c)[0],r={...c[h]};r.sprite_sheet_file_name=r.sprite_sheet_file_name.replace("{dir}",l[d]),r.sprite_sheet_dir=e.sprite_sheet_dir.replace("{sex}",o).replace("{skin}",a),this.animations.get(o).get(a).get(d).set(h,r)})})})})}},g=new f});var k,I,E=_(()=>{k=class{constructor(){this._up=!1,this._down=!1,this._left=!1,this._right=!1,this._input={UP:0,DOWN:1,LEFT:2,RIGHT:3},this._code_map={KeyW:this._input.UP,ArrowUp:this._input.UP,KeyS:this._input.DOWN,ArrowDown:this._input.DOWN,KeyA:this._input.LEFT,ArrowLeft:this._input.LEFT,KeyD:this._input.RIGHT,ArrowRight:this._input.RIGHT}}instantiate_input(){$(document).on("keydown keyup",t=>{let e=this._code_map[t.code];if(e===void 0)return;let i=t.type==="keydown";switch(e){case this._input.UP:this._up=i;break;case this._input.DOWN:this._down=i;break;case this._input.LEFT:this._left=i;break;case this._input.RIGHT:this._right=i;break}t.preventDefault()})}get_up(){return this._up}get_down(){return this._down}get_left(){return this._left}get_right(){return this._right}get_state(){return{up:this._up,down:this._down,left:this._left,right:this._right}}},I=new k});var u,P=_(()=>{u=class{constructor(){this._body_animation_textures=new Map,this._sprite=null}async instantiate(t,e){let i=Array.from(t.entries()).map(async([p,l])=>{let o=await this._create_textures_from_spritesheet(l,e);this._body_animation_textures.set(p,o)});await Promise.all(i);let s=this._body_animation_textures.get("idle_normal_loop1");s&&s.length>0&&(this._sprite=new PIXI.Sprite(s[0]))}get_sprite(){return this._sprite}async _create_textures_from_spritesheet(t,e){let i=[],s=t.frame_width,p=t.num_frames,l="/images/avatars/male_color1/"+t.sprite_sheet_file_name,o=await PIXI.Assets.load(l);o.source.scaleMode="nearest";for(let a=0;a<p;a++){let d=a*s,c=0,h=new PIXI.Rectangle(d,c,s,s),r=new PIXI.Texture({source:o.source,frame:h});i.push(r)}return i}}});var w,T=_(()=>{w=class{constructor(){this._pixi_app=null}async instantiate(){this._pixi_app=new PIXI.Application;let t=window.innerWidth*.9,e=t/320;await this._pixi_app.init({width:320,height:180,resolution:e,autoDensity:!0,antialias:!1,roundPixels:!0}),this._pixi_app.canvas.style.width=`${t}px`,this._pixi_app.canvas.style.height=`${180*e}px`,this._pixi_app.canvas.style.imageRendering="pixelated",document.body.appendChild(this._pixi_app.canvas)}async make_entrance(t){this._pixi_app.stage.addChild(t)}async make_exit(t){this._pixi_app.stage.removeChild(t)}}});var y,R,A=_(()=>{y=class{constructor(t){this._connection=null,this._hub_url=t,this._is_connected=!1,this._reconnect_delay=5e3,this._tick_callback=null,this._connected_callback=null,this._disconnected_callback=null}async start(){this._connection=new signalR.HubConnectionBuilder().withUrl(this._hub_url).withHubProtocol(new signalR.protocols.msgpack.MessagePackHubProtocol).withAutomaticReconnect().configureLogging(signalR.LogLevel.Information).build(),this._connection.on("receive_tick",t=>{this._tick_callback&&this._tick_callback(t)}),this._connection.onclose(()=>{this._is_connected=!1,this._disconnected_callback&&this._disconnected_callback(),this._attempt_reconnect()}),this._connection.onreconnected(()=>{this._is_connected=!0,this._connected_callback&&this._connected_callback()});try{await this._connection.start(),this._is_connected=!0,console.log("Its connected!"),this._connected_callback&&this._connected_callback()}catch(t){console.error("SignalR connection failed:",t),this._attempt_reconnect()}}async _attempt_reconnect(){this._is_connected||setTimeout(()=>this.start(),this._reconnect_delay)}async stop(){this._connection&&(await this._connection.stop(),this._is_connected=!1)}on_tick(t){this._tick_callback=t}on_connected(t){this._connected_callback=t}on_disconnected(t){this._disconnected_callback=t}get is_connected(){return this._is_connected}async invoke_server_method(t,...e){if(this._is_connected)try{return await this._connection.invoke(t,...e)}catch(i){throw console.error(`Failed to invoke ${t}:`,i),i}}},R=new y("/poctick")});var H=_(()=>{});var b,L,D=_(()=>{H();b=class{constructor(){this.active_controller=null,this.container=$("#modal_container"),this.callback=null}async open(t,e){var i=await(await fetch(`/Modal/Fetch/${t}`)).text();let s=await import(`/js/modals/controllers/${t}.js`);this.show_content(i),this.activeController=new s.Controller,this.callback=e}show_content(t){this.container.html(t),this.container.show()}hide_content(){this.container.hide()}async close(){this.callback()}},L=new b});var U=C(()=>{x();v();E();P();T();A();D();var M={Avatar:m,SetAvatar:u,SetManager:w,avatar_animation_data:g,input_manager:I,signal_r_manager:R,modal_manager:L,Init:async()=>{await g.load(),console.log("Theater App initialized")}};window.THTR=M});U();})();
